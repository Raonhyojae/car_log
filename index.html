<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>차량운행기록부 - 7월 출발누적거리 고정 및 차량 추가</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container" role="main" aria-label="차량운행기록부">
    <h1>차량운행기록부</h1>

    <div class="info-box" role="region" aria-label="사업 정보">
      <div><strong>사업연도</strong> : <span id="business-year">로딩중...</span></div>
      <div><strong>사업자 등록번호</strong> : 214-86-53129</div>
    </div>

    <div class="table-wrapper" aria-label="기본 정보">
      <table aria-describedby="basic-info-caption" id="basic-info-table">
        <caption id="basic-info-caption">기본 차량 정보</caption>
        <thead>
          <tr>
            <th scope="col">차종</th>
            <th scope="col">차량번호</th>
            <th scope="col">자택</th>
            <th scope="col">근무지</th>
            <th scope="col">출퇴근거리(km)</th>
          </tr>
        </thead>
        <tbody id="basic-info-tbody" tabindex="0">
          <tr data-vehicle-id="185나8606" tabindex="0">
            <td class="selectable-vehicle">레이밴</td>
            <td>185나8606</td>
            <td contenteditable="true" aria-label="자택 편집">서울시 강남구</td>
            <td>㈜이스트림</td>
            <td contenteditable="true" aria-label="출퇴근거리 편집">25</td>
          </tr>
          <tr data-vehicle-id="823로5420" tabindex="0">
            <td class="selectable-vehicle">스타리아</td>
            <td>823로5420</td>
            <td contenteditable="true" aria-label="자택 편집">서울시 성동구</td>
            <td>㈜이스트림</td>
            <td contenteditable="true" aria-label="출퇴근거리 편집">30</td>
          </tr>
          <tr data-vehicle-id="25나1234" tabindex="0">
            <td class="selectable-vehicle">그랜저</td>
            <td>25나1234</td>
            <td contenteditable="true" aria-label="자택 편집">서울시 송파구</td>
            <td>㈜이스트림</td>
            <td contenteditable="true" aria-label="출퇴근거리 편집">20</td>
          </tr>
          <tr data-vehicle-id="45로5678" tabindex="0">
            <td class="selectable-vehicle">쏘렌토</td>
            <td>45로5678</td>
            <td contenteditable="true" aria-label="자택 편집">서울시 마포구</td>
            <td>㈜이스트림</td>
            <td contenteditable="true" aria-label="출퇴근거리 편집">28</td>
          </tr>
        </tbody>
      </table>
    </div>

    <section id="trip-log-section" style="display:none;" aria-label="운행 기록">
      <h2>운행 기록부</h2>
      <div id="selected-vehicle-name" style="font-weight: 600; margin-bottom: 1rem;">차량을 선택하세요</div>

      <table id="trip-log-table" aria-describedby="trip-log-caption" style="width:100%; border-collapse: collapse; margin-bottom: 1rem;">
        <caption id="trip-log-caption">선택된 차량 운행 기록</caption>
        <thead>
          <tr>
            <th>날짜</th>
            <th>출발 누적거리</th>
            <th>도착 누적거리</th>
            <th>주행거리(보정)</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody id="trip-log-tbody">
          <!-- 운행 기록이 동적으로 추가됩니다 -->
        </tbody>
      </table>

      <form id="trip-log-form" aria-label="운행 기록 추가 폼">
        <fieldset>
          <legend>운행 기록 추가</legend>
          <label for="trip-date">날짜:</label>
          <input type="date" id="trip-date" name="trip-date" required />
          <label for="departure-distance">출발 누적거리:</label>
          <input type="number" id="departure-distance" name="departure-distance" min="0" required />
          <label for="arrival-distance">도착 누적거리:</label>
          <input type="number" id="arrival-distance" name="arrival-distance" min="0" required />
          <label for="notes">비고:</label>
          <input type="text" id="notes" name="notes" />
          <button type="submit">추가</button>
        </fieldset>
      </form>
    </section>

  </div>

  <script>
    // 차량별 첫 출발 누적거리 저장
    const initialDepartureDistances = {};

    // 현재 선택 차량 ID 및 이름
    let selectedVehicleId = null;
    let selectedVehicleName = "";

    // 운행 기록 저장 배열
    const tripLogs = [];

    // 사업연도 표시 함수
    function setBusinessYear() {
      const yearElem = document.getElementById('business-year');
      if (yearElem) {
        const now = new Date();
        yearElem.textContent = now.getFullYear() + '년';
      }
    }

    // 차량 선택 함수
    function selectVehicle(row) {
      // 선택 해제 및 선택 표시
      document.querySelectorAll('#basic-info-tbody tr').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');

      selectedVehicleId = row.dataset.vehicleId;
      selectedVehicleName = row.querySelector('td.selectable-vehicle').textContent;

      document.getElementById('selected-vehicle-name').textContent = `${selectedVehicleName} (${selectedVehicleId})`;
      document.getElementById('trip-log-section').style.display = 'block';

      renderTripLogs();
      resetForm();
    }

    // 주행거리 보정 함수
    function calculateAdjustedDistances(vehicleId, departureDist, arrivalDist) {
      if (!(vehicleId in initialDepartureDistances)) {
        initialDepartureDistances[vehicleId] = departureDist;
      }
      const adjustedDeparture = departureDist - initialDepartureDistances[vehicleId];
      const adjustedArrival = arrivalDist - initialDepartureDistances[vehicleId];
      const adjustedDistance = adjustedArrival - adjustedDeparture;
      return {
        adjustedDeparture,
        adjustedArrival,
        adjustedDistance
      };
    }

    // 운행 기록 렌더링
    function renderTripLogs() {
      const tbody = document.getElementById('trip-log-tbody');
      tbody.innerHTML = '';

      const filteredLogs = tripLogs.filter(log => log.vehicleId === selectedVehicleId);
      filteredLogs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${log.date}</td>
          <td>${log.departureDistance}</td>
          <td>${log.arrivalDistance}</td>
          <td>${log.adjustedDistance}</td>
          <td>${log.notes || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 폼 초기화
    function resetForm() {
      const form = document.getElementById('trip-log-form');
      form.reset();
    }

    // 폼 제출 처리
    function handleFormSubmit(event) {
      event.preventDefault();
      if (!selectedVehicleId) {
        alert('차량을 선택해주세요.');
        return;
      }

      const date = document.getElementById('trip-date').value;
      const departureDistance = Number(document.getElementById('departure-distance').value);
      const arrivalDistance = Number(document.getElementById('arrival-distance').value);
      const notes = document.getElementById('notes').value;

      if (arrivalDistance < departureDistance) {
        alert('도착 누적거리는 출발 누적거리보다 작을 수 없습니다.');
        return;
      }

      const { adjustedDistance } = calculateAdjustedDistances(selectedVehicleId, departureDistance, arrivalDistance);

      tripLogs.push({
        vehicleId: selectedVehicleId,
        date,
        departureDistance,
        arrivalDistance,
        adjustedDistance,
        notes
      });

      renderTripLogs();
      resetForm();
    }

    // 초기화 함수
    function init() {
      setBusinessYear();

      // 차량 선택 이벤트 바인딩
      document.querySelectorAll('#basic-info-tbody tr').forEach(row => {
        row.addEventListener('click', () => selectVehicle(row));
        row.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectVehicle(row);
          }
        });
      });

      // 폼 제출 이벤트 바인딩
      document.getElementById('trip-log-form').addEventListener('submit', handleFormSubmit);
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>